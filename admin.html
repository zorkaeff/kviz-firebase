<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<title>Kviz – Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; background:#111; color:white; text-align:center; }
button { margin:8px; padding:14px 22px; font-size:22px; cursor:pointer; }
#players, #answersTable { margin:20px auto; width:90%; border-collapse:collapse; }
#players th, #players td, #answersTable th, #answersTable td { border:1px solid white; padding:6px; text-align:center; }
th { background:#222; }
#controls { display:none; margin-top:20px; }
#answersTable { max-height:300px; overflow-y:scroll; display:block; }
</style>
</head>
<body>

<h2>Admin – Kviz</h2>

<div id="loginDiv">
  <input type="password" id="adminkey" placeholder="Admin ključ" />
  <button onclick="login()">Login</button>
</div>

<div id="controls">
  <button onclick="startGame()">▶ Start kviza</button>
  <button onclick="pauseGame()">⏸ Pauza</button>
  <button onclick="resumeGame()">▶ Nastavi</button>
  <button onclick="nextQuestion()">➡ Sljedeće pitanje</button>
  <button onclick="eliminate()">❌ Eliminiraj zadnjeg</button>
</div>

<h3>Prijavljeni igrači</h3>
<table id="players">
<thead><tr><th>Igrač</th><th>Bodovi</th><th>!</th><th>?</th></tr></thead>
<tbody></tbody>
</table>

<h3>Detaljan pregled odgovora</h3>
<table id="answersTable">
  <thead>
    <tr>
      <th>Krug</th>
      <th>Pitanje</th>
      <th>Igrač</th>
      <th>Odgovor</th>
      <th>Bodovi</th>
      <th>Vrijeme (s)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const ADMIN_KEY="tajni123";
const firebaseConfig={
  apiKey:"AIzaSyB5jeu860fNmmysc51wcb5fej7Bz_6gW-Q",
  authDomain:"hpddd-b9bef.firebaseapp.com",
  databaseURL:"https://hpddd-b9bef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"hpddd-b9bef",
  storageBucket:"hpddd-b9bef.appspot.com",
  messagingSenderId:"520105963434",
  appId:"1:520105963434:web:5b25d1f9f28512ae1145d3"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
let paused=false;

// LOGIN
function login(){
  const key=document.getElementById("adminkey").value;
  if(key===ADMIN_KEY){
    document.getElementById("controls").style.display="block";
    document.getElementById("loginDiv").style.display="none";
    updatePlayers();
    updateAnswerDetails();
  } else alert("Krivi ključ");
}

// START KVIZA
function startGame(){
  const now=Date.now();
  db.ref('game').set({
    round:1, question:1, phase:'main', phaseEndsAt:now+20000,
    questionText:"Pitanje 1 krug 1",
    correct:"A",
    choices:['A','B','C','D'],
    values:{'!':10,'.':5,'?':5, wrong:{'!':-10,'.':0,'?':-5}}
  });
}

// PAUZA
function pauseGame(){
  paused=true;
  db.ref('game').once('value').then(snap=>{
    const g = snap.val();
    db.ref('game').update({phase:'paused', phasePrev: g.phase});
  });
}

// NASTAVI
function resumeGame(){
  paused=false;
  db.ref('game').once('value').then(snap=>{
    const g = snap.val();
    if(!g) return;
    const now=Date.now();
    const remaining=g.phaseEndsAt-now;
    db.ref('game').update({phase:g.phasePrev||'main', phaseEndsAt:now+remaining});
  });
}

// SLJEDEĆE PITANJE
function nextQuestion(){
  db.ref('game').once('value').then(snap=>{
    const g=snap.val()||{round:1,question:0};
    const valMap = {'!':g.round*10,'.':g.round*5,'?':g.round*5, wrong:{'!':-g.round*10,'.':0,'?':-g.round*5}};
    const next={round:g.round, question:g.question+1, phase:'main', phaseEndsAt:Date.now()+20000,
                questionText:`Pitanje ${g.question+1} krug ${g.round}`,
                correct:['A','B','C','D'][Math.floor(Math.random()*4)],
                choices:['A','B','C','D'], values:valMap};
    db.ref('game').set(next);
  });
}

// ELIMINACIJA
function eliminate(){
  db.ref('results').once('value').then(snap=>{
    const players=[];
    snap.forEach(ch=>{
      const r=ch.val(); 
      players.push({name:ch.key,points:r.points||0,question:r.question||0,exclam:r.exclam||0,time:r.time||0});
    });
    if(players.length<=1){ alert("Ne može eliminirati – ostao je jedan igrač"); return; }
    players.sort((a,b)=>{
      if(a.points!==b.points) return a.points-b.points;
      if(a.question!==b.question) return a.question-b.question;
      if(a.exclam!==b.exclam) return a.exclam-b.exclam;
      return b.time-a.time;
    });
    const eliminated=players[0];
    if(confirm(`Eliminirati ${eliminated.name}?`)){
      db.ref(`players/${eliminated.name}`).remove();
      db.ref(`eliminated/${eliminated.name}`).set({ at: Date.now() });
      alert(`${eliminated.name} eliminiran`);
    }
  });
}

// LEADERBOARD
function updatePlayers(){
  db.ref('results').on('value',snap=>{
    const tbody=document.querySelector('#players tbody'); tbody.innerHTML="";
    snap.forEach(ch=>{
      const r=ch.val(); 
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ch.key}</td><td>${r.points||0}</td><td>${r.exclam||0}</td><td>${r.question||0}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// DETALJAN PREGLED ODGOVORA
function updateAnswerDetails(){
  const tbody = document.querySelector('#answersTable tbody');
  db.ref('answers').on('value', snap=>{
    tbody.innerHTML="";
    snap.forEach(roundSnap=>{
      roundSnap.forEach(qSnap=>{
        const qKey = qSnap.key;
        qSnap.forEach(playerSnap=>{
          const data = playerSnap.val();
          db.ref(`results/${playerSnap.key}`).once('value').then(resSnap=>{
            const points = resSnap.val()?.points || 0;
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${roundSnap.key}</td>
                          <td>${qKey}</td>
                          <td>${playerSnap.key}</td>
                          <td>${data.choice}</td>
                          <td>${points}</td>
                          <td>${Math.floor((data.time || 0)/1000)}</td>`;
            tbody.appendChild(tr);
          });
        });
      });
    });
  });
}
</script>
</body>
</html>
