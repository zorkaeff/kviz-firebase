<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<title>Multiplayer Turnir Kviz</title>
<link rel="icon" href="data:,">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background:#111; color:white; text-align:center; }
button { margin:4px; padding:8px 12px; font-size:16px; cursor:pointer; }
.hidden { display:none; }
.timer { font-size:32px; margin:10px; }
#leaderboardTable { margin:auto; margin-top:20px; color:white; border-collapse: collapse; }
#leaderboardTable th, #leaderboardTable td { border:1px solid white; padding:4px 8px; }
.correct { color: #0f0; }
.wrong { color: #f33; }
</style>
</head>
<body>

<h2 id="questionText">Čekanje na početak kviza...</h2>
<p id="lobbyInfo">Čekanje na početak kviza...</p>
<p id="roundInfo">Krug: - | Pitanje: -</p>
<p id="valueInfo">Točan ! odgovor: -</p>
<div class="timer" id="timer">00</div>
<div id="answerButtons" class="hidden"></div>

<h3>Trenutni poredak</h3>
<table id="leaderboardTable">
  <thead>
    <tr>
      <th>Poredak</th>
      <th>Igrač</th>
      <th>Bodovi</th>
      <th>! odgovori</th>
      <th>? odgovori</th>
      <th>Vrijeme (s)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<canvas id="scoreChart" width="600" height="300"></canvas>

<script>
/* ===================== FIREBASE ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyB5jeu860fNmmysc51wcb5fej7Bz_6gW-Q",
  authDomain: "hpddd-b9bef.firebaseapp.com",
  databaseURL: "https://hpddd-b9bef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hpddd-b9bef",
  storageBucket: "hpddd-b9bef.appspot.com",
  messagingSenderId: "520105963434",
  appId: "1:520105963434:web:5b25d1f9f28512ae1145d3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== ANONYMOUS AUTH ===================== */
let playerName, uid;
firebase.auth().signInAnonymously()
  .then(() => {
    uid = firebase.auth().currentUser.uid;
    if(!localStorage.getItem("playerName")){
      do { playerName = prompt("Unesi ime igrača:")?.trim(); } while(!playerName);
      localStorage.setItem("playerName", playerName);
    }
    playerName = localStorage.getItem("playerName");

    db.ref("tournament/players/"+uid).set({
      name: playerName,
      joinedAt: Date.now(),
      totalPoints:0,
      usedExclam:0,
      usedLukavac:0,
      totalAnswerTime:0,
      eliminated:false
    });

    startLobby();
  })
  .catch(e=>{ console.error("Auth error:",e); alert("Greška s autentifikacijom."); });

/* ===================== LOBBY ===================== */
const lobbyInfo = document.getElementById("lobbyInfo");
const roundInfoEl = document.getElementById("roundInfo");
const valueInfoEl = document.getElementById("valueInfo");
const questionText = document.getElementById("questionText");
const answerButtons = document.getElementById("answerButtons");
const timerEl = document.getElementById("timer");

let currentRound=1, currentQuestionIndex=0, questionStartTime=0;
const rounds=6, questionsPerRound=10;
const baseExclamValue=100; // raste po krugu

/* ===================== PITANJA ===================== */
// 6 krugova × 10 pitanja = 60 pitanja
// Copy/paste pitanja iz prethodnog primjera (allQuestions)
const allQuestions = [ /* ...6x10 pitanja... */ ];

/* ===================== LOBBY START ===================== */
const quizStartTime = new Date("2026-01-10T14:25:00+01:00").getTime();

function startLobby(){
  const interval = setInterval(()=>{
    const now = Date.now();
    if(now >= quizStartTime){
      clearInterval(interval);
      startQuestion();
    } else {
      const diff = Math.floor((quizStartTime - now)/1000);
      lobbyInfo.innerText = `Kviz počinje za ${diff} sekundi`;
    }
  },1000);
}

/* ===================== KVIZ LOGIKA ===================== */
let mainAnswered=false, usedLukavac=false, mainTimer=null, lukavacTimer=null;

// Start pitanja
function startQuestion(){
  if(currentQuestionIndex>=questionsPerRound){
    pauseBeforeNextRound();
    return;
  }
  mainAnswered=false; usedLukavac=false;
  const q = allQuestions[currentRound-1][currentQuestionIndex];
  currentCorrect = q.correct;
  questionText.innerText = q.text;
  roundInfoEl.innerText = `Krug: ${currentRound} | Pitanje: ${currentQuestionIndex+1}`;
  valueInfoEl.innerText = `Točan ! odgovor: ${baseExclamValue*currentRound}`;
  answerButtons.innerHTML = '';
  answerButtons.classList.remove("hidden");
  q.options.forEach((opt,i)=>{
    const letter = String.fromCharCode(65+i); // A,B,C,D
    const btn = document.createElement("button");
    btn.innerText = `${letter}!`;
    btn.onclick = ()=>answerMain(letter+"!");
    answerButtons.appendChild(btn);
    const btn2 = document.createElement("button");
    btn2.innerText = `${letter}.`;
    btn2.onclick = ()=>answerMain(letter+".");
    answerButtons.appendChild(btn2);
    const btn3 = document.createElement("button");
    btn3.innerText = `${letter}?`;
    btn3.onclick = ()=>answerMain(letter+"?");
    answerButtons.appendChild(btn3);
  });
  questionStartTime = Date.now();
  startMainTimer();
}

// Glavni timer 20s
let timeLeft=20;
function startMainTimer(){
  timerEl.innerText = timeLeft;
  mainTimer = setInterval(()=>{
    timerEl.innerText = timeLeft;
    timeLeft--;
    if(timeLeft<0){
      clearInterval(mainTimer);
      endMainPhase();
    }
  },1000);
}

// Odgovor glavne faze
function answerMain(choice){
  if(mainAnswered) return;
  mainAnswered=true;
  if(choice[1]=="?") usedLukavac=true;
  const pts = calculateMainPoints(choice);
  const answerTime = Math.floor((Date.now()-questionStartTime)/1000);
  db.ref(`tournament/results/${currentRound}_${currentQuestionIndex}/${uid}`).set({
    player:playerName,
    choice, pts, answerTime
  });
  if(choice[1]=="?") startLukavacPhase();
}

// Izračun bodova glavne faze
function calculateMainPoints(choice){
  const letter = choice[0];
  const type = choice[1];
  if(letter===currentCorrect) return type=="!"? baseExclamValue*currentRound : 50;
  else return type=="!"? -baseExclamValue*currentRound : 0;
}

// Lukavac faza 10s
function startLukavacPhase(){
  timeLeft=10; timerEl.innerText=timeLeft;
  lukavacTimer = setInterval(()=>{
    timerEl.innerText = timeLeft;
    timeLeft--;
    if(timeLeft<0){
      clearInterval(lukavacTimer);
      autoFailLukavac();
      showResultsPhase();
    }
  },1000);
}

// Auto fail
function autoFailLukavac(){
  db.ref(`tournament/results/${currentRound}_${currentQuestionIndex}/${uid}`).update({choice:"AUTO", pts:-50});
}

// Prikaz rezultata
function showResultsPhase(){
  // ovdje se prikazuje bodovi svih igrača, update leaderboard, graf
  updateLeaderboardTable();
  currentQuestionIndex++;
  setTimeout(()=>{ startQuestion(); },10000); // 10s prikaz rezultata
}

// Leaderboard
function updateLeaderboardTable(){
  db.ref('tournament/players').once('value').then(snap=>{
    const data = snap.val();
    const tbody = document.querySelector("#leaderboardTable tbody");
    tbody.innerHTML='';
    const arr = Object.values(data).sort((a,b)=>b.totalPoints-a.totalPoints);
    arr.forEach((p,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.totalPoints}</td><td>${p.usedExclam}</td><td>${p.usedLukavac}</td><td>${p.totalAnswerTime}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// Pauza između krugova 3 min
function pauseBeforeNextRound(){
  questionText.innerText=`Pauza između krugova. Sljedeći krug počinje za 3 minute.`;
  answerButtons.classList.add("hidden");
  setTimeout(()=>{
    currentRound++;
    currentQuestionIndex=0;
    if(currentRound>rounds){ questionText.innerText="Turnir gotov!"; return; }
    startQuestion();
  },3*60*1000);
}
</script>
</body>
</html>
