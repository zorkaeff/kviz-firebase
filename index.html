<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8" />
<title>Kviz</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; background:#111; color:white; text-align:center; }
button { margin:6px; padding:12px 18px; font-size:20px; cursor:pointer; display:block; width:120px; margin-left:auto; margin-right:auto; }
.hidden { display:none; }
.timer { font-size:36px; margin:10px; }
table { margin:auto; border-collapse: collapse; width: 80%; }
th, td { border: 1px solid white; padding: 6px; }
#optionsText { font-size:20px; margin:10px; }
</style>
</head>
<body>

<h2>Kviz Pitanja</h2>
<div class="timer" id="timer">ƒåekanje starta kviza...</div>
<div id="questionPhase" class="hidden">
  <h3 id="questionText"></h3>
  <div id="optionsText"></div>
  <div id="answerButtons"></div>
  <div id="roundInfo"></div>
</div>
<h3>Leaderboard</h3>
<table id="leaderboard">
  <thead>
    <tr><th>Igraƒç</th><th>Bodovi</th><th>!</th><th>?</th><th>Vrijeme (s)</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const player = localStorage.getItem("player") || prompt("Ime igraƒça:");
localStorage.setItem("player", player);

const firebaseConfig = {
  apiKey: "AIzaSyB5jeu860fNmmysc51wcb5fej7Bz_6gW-Q",
  authDomain: "hpddd-b9bef.firebaseapp.com",
  databaseURL: "https://hpddd-b9bef-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hpddd-b9bef",
  storageBucket: "hpddd-b9bef.appspot.com",
  messagingSenderId: "520105963434",
  appId: "1:520105963434:web:5b25d1f9f28512ae1145d3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// üî• Fiksni datum i vrijeme poƒçetka kviza
const quizStartTime = new Date('2026-01-10T15:10:00+01:00').getTime();

const rounds = 6;
const questionsPerRound = 10;
let currentRound = 0;
let currentQuestionIndex = 0;
let questionTimer;
let questionDuration = 20; // sekunde za regularni odgovor

const allQuestions = [
  [
    { text:"Koliko je 2 + 2?", correct:"C", options:["1","2","4","3"] },
    { text:"Koja boja je nebo?", correct:"A", options:["Plava","Zelena","Crvena","≈Ωuta"] }
  ],
  [ /* Krug 2 */ ],
  [ /* Krug 3 */ ],
  [ /* Krug 4 */ ],
  [ /* Krug 5 */ ],
  [ /* Krug 6 */ ]
];

function calcPoints(choice, correct) {
  if(choice.endsWith('!')) return choice[0]===correct ? 100 : -100;
  if(choice.endsWith('.')) return choice[0]===correct ? 50 : 0;
  if(choice.endsWith('?')) return choice[0]===correct ? 50 : -50;
  return 0;
}

function startQuiz(){
  document.getElementById("timer").innerText = "Kviz poƒçinje!";
  document.getElementById("questionPhase").classList.remove("hidden");
  startQuestion(currentRound,currentQuestionIndex);
}

// üî• Start kviza s provjerom
const now = Date.now();
if (quizStartTime > now) {
  setTimeout(startQuiz, quizStartTime - now);
} else {
  document.getElementById("timer").innerText = "ƒåekanje sljedeƒáeg kviza...";
}

function startQuestion(round,index){
  if(round>=rounds) return;
  const question = allQuestions[round][index];
  document.getElementById("questionText").innerText = question.text;
  document.getElementById("roundInfo").innerText = `Krug ${round+1}, Pitanje ${index+1}`;

  // Prikaz ponuƒëenih odgovora
  document.getElementById("optionsText").innerHTML = question.options.map((opt,i)=>`${String.fromCharCode(65+i)}: ${opt}`).join('<br>');

  const buttonsDiv = document.getElementById("answerButtons");
  buttonsDiv.innerHTML='';
  ['A','B','C','D'].forEach(opt=>{
    ['.','!','?'].forEach(suffix=>{
      const btn=document.createElement('button');
      btn.innerText = opt+suffix;
      btn.onclick=()=>submitAnswer(opt+suffix);
      buttonsDiv.appendChild(btn);
    });
  });

  // Pokreni timer za pitanje
  let timeLeft = questionDuration;
  questionTimer = setInterval(()=>{
    document.getElementById("timer").innerText=`Vrijeme: ${timeLeft}s`;
    timeLeft--;
    if(timeLeft<0){
      clearInterval(questionTimer);
      processQuestionAnswers(round,index);
    }
  },1000);
}

function submitAnswer(choice){
  // Ne zaustavljamo timer, samo spremamo odgovor u Firebase
  db.ref(`answers/${currentRound}/${currentQuestionIndex}/${player}`).set({choice, timestamp: Date.now()});
}

function processQuestionAnswers(round,index){
  // Prika≈æi bodove nakon isteka vremena
  db.ref(`answers/${round}/${index}`).once('value',snap=>{
    const allAnswers = snap.val() || {};
    for(const p in allAnswers){
      const choice = allAnswers[p].choice;
      const correct = allQuestions[round][index].correct;
      const points = calcPoints(choice,correct);
      db.ref(`results/${p}`).once('value',rsnap=>{
        let data = rsnap.val() || {points:0,exclam:0,questionMarks:0,timeUsed:0};
        if(choice.endsWith('!')) data.exclam++;
        if(choice.endsWith('?')) data.questionMarks++;
        data.points += points;
        db.ref(`results/${p}`).set(data);
        updateLeaderboard();
      });
    }
  });

  // Odlazak na sljedeƒáe pitanje nakon 40 sekundi prikaza
  setTimeout(()=>{
    currentQuestionIndex++;
    if(currentQuestionIndex>=questionsPerRound){
      currentRound++; currentQuestionIndex=0;
    }
    if(currentRound<rounds) startQuestion(currentRound,currentQuestionIndex);
  },40000);
}

function updateLeaderboard(){
  db.ref('results').once('value',snap=>{
    const tbody=document.querySelector('#leaderboard tbody');
    tbody.innerHTML='';
    const players=[];
    snap.forEach(ch=>players.push({name:ch.key,...ch.val()}));
    players.sort((a,b)=>{
      if(b.points!==a.points) return b.points-a.points;
      if(a.exclam!==b.exclam) return a.exclam-b.exclam;
      return 0;
    });
    players.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.name}</td><td>${p.points}</td><td>${p.exclam}</td><td>${p.questionMarks}</td><td>${p.timeUsed}</td>`;
      tbody.appendChild(tr);
    });
  });
}
</script>
</body>
</html>
